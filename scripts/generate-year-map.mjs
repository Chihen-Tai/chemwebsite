#!/usr/bin/env node
import fs from "fs";
import path from "path";
import vm from "vm";
import { execSync } from "child_process";

const root = path.resolve("/Applications/codes/chemwebsite");
const dataPath = path.join(root, "src", "data.js");
const outPath = path.join(root, "src", "year-map.js");

const sandbox = { window: {} };
const dataCode = fs.readFileSync(dataPath, "utf8");
vm.runInNewContext(dataCode, sandbox);

const posts = Array.isArray(sandbox.window.POSTS) ? sandbox.window.POSTS : [];

function canonicalKey(p) {
  return String(p || "")
    .replace(/^\.\/+/, "")
    .replace(/^\.\.\/+/, "")
    .replace(/\\/g, "/");
}

function fromRocYear(s) {
  const m = String(s || "").match(/(?:^|[^0-9])(1\d{2})(?:[^0-9]|$)/);
  if (!m) return "";
  const n = Number(m[1]);
  if (!Number.isFinite(n) || n < 100 || n > 199) return "";
  return String(n + 1911);
}

function fromAdYear(s) {
  const m = String(s || "").match(/(19|20)\d{2}/);
  return m ? m[0] : "";
}

function fromClassCode(s) {
  const m = String(s || "").match(/class(\d{2})/i);
  if (!m) return "";
  const n = Number(m[1]);
  if (!Number.isFinite(n)) return "";
  return String(2000 + n - 1);
}

function fromPdfContent(absPath) {
  if (!/\.pdf$/i.test(absPath)) return "";
  if (!fs.existsSync(absPath)) return "";
  try {
    const cmd = `strings -n 4 "${absPath.replace(/"/g, '\\"')}" | rg -o "(19|20)[0-9]{2}"`;
    const output = execSync(cmd, { encoding: "utf8", stdio: ["ignore", "pipe", "ignore"] });
    const years = output
      .split(/\s+/)
      .map((x) => x.trim())
      .filter((x) => /^\d{4}$/.test(x))
      .map(Number)
      .filter((x) => x >= 1990 && x <= 2100);
    if (!years.length) return "";
    const score = new Map();
    for (const y of years) score.set(y, (score.get(y) || 0) + 1);
    return String([...score.entries()].sort((a, b) => b[1] - a[1])[0][0]);
  } catch {
    return "";
  }
}

const rawPaths = posts.flatMap((p) => {
  if (Array.isArray(p.attachments)) return p.attachments;
  if (typeof p.attachment === "string" && p.attachment.trim()) return [p.attachment];
  return [];
});

const uniq = [...new Set(rawPaths.map((x) => String(x).trim()).filter(Boolean))];
const yearMap = {};

for (const rel of uniq) {
  const key = canonicalKey(rel);
  const abs = path.join(root, key);

  let year = "";
  year = year || fromAdYear(rel);
  year = year || fromRocYear(rel);
  year = year || fromClassCode(rel);
  year = year || fromPdfContent(abs);

  if (year) yearMap[key] = year;
}

const out = `// Auto-generated by scripts/generate-year-map.mjs\nwindow.YEAR_MAP = ${JSON.stringify(
  yearMap,
  null,
  2
)};\n`;
fs.writeFileSync(outPath, out, "utf8");
console.log(`Generated ${outPath} (${Object.keys(yearMap).length} entries)`);
